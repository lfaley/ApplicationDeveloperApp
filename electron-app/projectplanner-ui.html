<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ProjectPlanner - Unified GUI</title>
  <link rel="stylesheet" href="context-agent-ui.css">
</head>
<body>
  <!-- UI content is unchanged, see source for details -->
<div class="section panel">
  <h3>New Project Creation</h3>
  <form id="new-project-form" enctype="multipart/form-data">
    <input class="input" type="text" placeholder="Project Name" name="projectName" required>
    <div style="display:flex;gap:8px;align-items:center;">
      <input class="input" type="text" placeholder="Destination Path" name="projectPath" id="projectPath" required style="flex:1;">
      <button type="button" class="button" id="browseProjectPath">Browse</button>
    </div>
    <select class="input" name="framework">
      <option value="">Select Framework</option>
      <option value="React">React</option>
      <option value="Next.js">Next.js</option>
      <option value="Node.js">Node.js</option>
      <option value="Python">Python</option>
      <option value="C#">C#</option>
    </select>
    <!-- ...rest of form unchanged... -->
  </form>
  <div id="new-project-result" style="margin-top:10px;"></div>
</div>
<div class="section panel">
  <h3>Existing Project Assessment</h3>
  <form id="existing-project-form">
    <div style="display:flex;gap:8px;align-items:center;">
      <input class="input" type="text" placeholder="Repository Path" name="repoPath" id="repoPath" required style="flex:1;">
      <button type="button" class="button" id="browseRepoPath">Browse</button>
    </div>
    <button class="button" type="submit">Assess Project</button>
  </form>
  <div id="assessment-loader" style="display:none;margin-top:10px;text-align:center;">
    <span class="loader"></span> <span>Assessing project...</span>
  </div>
  <div id="assessment-result" style="margin-top:10px;"></div>
</div>
<div class="section panel">
  <h3>Documentation Automation</h3>
  <form id="doc-automation-form">
    <div style="display:flex;gap:8px;align-items:center;">
      <input class="input" type="text" placeholder="Project Path" name="docPath" id="docPath" required style="flex:1;">
      <button type="button" class="button" id="browseDocPath">Browse</button>
    </div>
    <button class="button" type="submit">Generate/Sync Documentation</button>
  </form>
  <div id="doc-automation-result" style="margin-top:10px;"></div>
</div>
<div style="margin:16px 0;">
  <label><input type="checkbox" id="verbose-toggle"> Show technical details</label>
</div>
<div id="global-loader" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.6);z-index:9999;text-align:center;">
  <div style="position:relative;top:40vh;">
    <span class="loader"></span>
    <span style="font-size:1.2em;margin-left:10px;">Loading...</span>
  </div>
</div>
<script>
  // Loader control
  function showLoader() {
    document.getElementById('global-loader').style.display = 'block';
  }
  function hideLoader() {
    document.getElementById('global-loader').style.display = 'none';
  }
  function showResult(div, response) {
    const verbose = document.getElementById('verbose-toggle').checked;
    if (response && response.success) {
      div.textContent = response.output || 'Operation complete.';
    } else if (response) {
      let html = `<div><strong>${response.plainEnglish || 'Error occurred.'}</strong></div>`;
      if (verbose && (response.technical || response.stack || response.context || response.output)) {
        html += `<pre style='white-space:pre-wrap;font-size:0.95em;color:#a00;margin-top:8px;'>${
          response.technical ? 'Technical: ' + response.technical + '\n' : ''
        }${
          response.stack ? 'Stack: ' + response.stack + '\n' : ''
        }${
          response.context ? 'Context: ' + response.context + '\n' : ''
        }${
          response.output ? 'Output: ' + response.output + '\n' : ''
        }</pre>`;
      }
      div.innerHTML = html;
    } else {
      div.textContent = '';
    }
  }

  // Electron IPC for folder selection
  const { ipcRenderer } = window.require ? window.require('electron') : {};
  function setupBrowseButton(inputId, buttonId) {
    const input = document.getElementById(inputId);
    const button = document.getElementById(buttonId);
    if (input && button && ipcRenderer) {
      button.addEventListener('click', async () => {
        showLoader();
        const folder = await ipcRenderer.invoke('select-folder');
        hideLoader();
        if (folder) input.value = folder;
      });
    }
  }
  setupBrowseButton('projectPath', 'browseProjectPath');
  setupBrowseButton('repoPath', 'browseRepoPath');
  setupBrowseButton('docPath', 'browseDocPath');

  // Loader logic for assessment
  const assessmentForm = document.getElementById('existing-project-form');
  const resultDiv = document.getElementById('assessment-result');
  const repoPathInput = document.getElementById('repoPath');
  if (assessmentForm && ipcRenderer) {
    assessmentForm.addEventListener('submit', async (e) => {
      e.preventDefault(); // Prevent form reset
      showLoader();
      resultDiv.textContent = '';
      const repoPath = repoPathInput.value;
      const tool = 'assess';
      try {
        const response = await ipcRenderer.invoke('run-tool', { tool, repoPath });
        hideLoader();
        showResult(resultDiv, response);
      } catch (err) {
        hideLoader();
        showResult(resultDiv, err);
      }
    });
  }

  // Loader logic for new project creation
  const newProjectForm = document.getElementById('new-project-form');
  const newProjectResult = document.getElementById('new-project-result');
  if (newProjectForm && ipcRenderer) {
    newProjectForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      showLoader();
      newProjectResult.textContent = '';
      const formData = new FormData(newProjectForm);
      const data = {
        projectName: formData.get('projectName'),
        projectPath: formData.get('projectPath'),
        framework: formData.get('framework'),
        // Add other fields as needed
      };
      try {
        const response = await ipcRenderer.invoke('create-project', data);
        hideLoader();
        showResult(newProjectResult, response);
      } catch (err) {
        hideLoader();
        showResult(newProjectResult, err);
      }
    });
  }

  // Loader logic for documentation automation
  const docForm = document.getElementById('doc-automation-form');
  const docResult = document.getElementById('doc-automation-result');
  if (docForm && ipcRenderer) {
    docForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      showLoader();
      docResult.textContent = '';
      const docPath = document.getElementById('docPath').value;
      const tool = 'doc-automation';
      try {
        const response = await ipcRenderer.invoke('run-tool', { tool, repoPath: docPath });
        hideLoader();
        showResult(docResult, response);
      } catch (err) {
        hideLoader();
        showResult(docResult, err);
      }
    });
  }

  // Re-render results on verbosity toggle
  document.getElementById('verbose-toggle').addEventListener('change', () => {
    showResult(resultDiv, window.lastAssessmentResponse || {});
    showResult(newProjectResult, window.lastNewProjectResponse || {});
    showResult(docResult, window.lastDocAutomationResponse || {});
  });
</script>
<style>
.loader {
  display: inline-block;
  width: 24px;
  height: 24px;
  border: 3px solid #ccc;
  border-top: 3px solid #0078d7;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  vertical-align: middle;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
#global-loader {
  /* already styled inline */
}
</style>
</body>
</html>
